<!DOCTYPE html>
<html>
  <head>
    <title>Semi-automatic Jenkins upgrade on Windows</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    
    
    <link rel="apple-touch-icon" sizes="57x57" href="//pdudits.github.io/themes/uno-zen/assets/img/apple-touch-icon-57x57.png?v=wAAv6Wqe6l?v=1504855821302">
    <link rel="apple-touch-icon" sizes="60x60" href="//pdudits.github.io/themes/uno-zen/assets/img/apple-touch-icon-60x60.png?v=wAAv6Wqe6l?v=1504855821302">
    <link rel="apple-touch-icon" sizes="72x72" href="//pdudits.github.io/themes/uno-zen/assets/img/apple-touch-icon-72x72.png?v=wAAv6Wqe6l?v=1504855821302">
    <link rel="apple-touch-icon" sizes="76x76" href="//pdudits.github.io/themes/uno-zen/assets/img/apple-touch-icon-76x76.png?v=wAAv6Wqe6l?v=1504855821302">
    <link rel="apple-touch-icon" sizes="114x114" href="//pdudits.github.io/themes/uno-zen/assets/img/apple-touch-icon-114x114.png?v=wAAv6Wqe6l?v=1504855821302">
    <link rel="apple-touch-icon" sizes="120x120" href="//pdudits.github.io/themes/uno-zen/assets/img/apple-touch-icon-120x120.png?v=wAAv6Wqe6l?v=1504855821302">
    <link rel="apple-touch-icon" sizes="144x144" href="//pdudits.github.io/themes/uno-zen/assets/img/apple-touch-icon-144x144.png?v=wAAv6Wqe6l?v=1504855821302">
    <link rel="apple-touch-icon" sizes="152x152" href="//pdudits.github.io/themes/uno-zen/assets/img/apple-touch-icon-152x152.png?v=wAAv6Wqe6l?v=1504855821302">
    <link rel="apple-touch-icon" sizes="180x180" href="//pdudits.github.io/themes/uno-zen/assets/img/apple-touch-icon-180x180.png?v=wAAv6Wqe6l?v=1504855821302">
    <link rel="icon" type="image/png" href="//pdudits.github.io/themes/uno-zen/assets/img/favicon-32x32.png?v=wAAv6Wqe6l?v=1504855821302" sizes="32x32">
    <link rel="icon" type="image/png" href="//pdudits.github.io/themes/uno-zen/assets/img/favicon-194x194.png?v=wAAv6Wqe6l?v=1504855821302" sizes="194x194">
    <link rel="icon" type="image/png" href="//pdudits.github.io/themes/uno-zen/assets/img/favicon-96x96.png?v=wAAv6Wqe6l?v=1504855821302" sizes="96x96">
    <link rel="icon" type="image/png" href="//pdudits.github.io/themes/uno-zen/assets/img/android-chrome-192x192.png?v=wAAv6Wqe6l?v=1504855821302" sizes="192x192">
    <link rel="icon" type="image/png" href="//pdudits.github.io/themes/uno-zen/assets/img/favicon-16x16.png?v=wAAv6Wqe6l?v=1504855821302" sizes="16x16">
    <link rel="manifest" href="//pdudits.github.io/themes/uno-zen/assets/img/manifest.json?v=wAAv6Wqe6l?v=1504855821302">
    <link rel="shortcut icon" href="//pdudits.github.io/themes/uno-zen/assets/img/favicon.ico?v=wAAv6Wqe6l?v=1504855821302">
    <meta name="msapplication-TileColor" content="#e74c3c">
    <meta name="msapplication-TileImage" content="//pdudits.github.io/themes/uno-zen/assets/img/mstile-144x144.png?v=wAAv6Wqe6l?v=1504855821302">
    <meta name="msapplication-config" content="//pdudits.github.io/themes/uno-zen/assets/img/browserconfig.xml?v=wAAv6Wqe6l?v=1504855821302">
    <meta name="theme-color" content="#e74c3c">
    <link rel="stylesheet" type="text/css" href="//pdudits.github.io/themes/uno-zen/assets/css/uno-zen.css?v=1504855821302" />
    <link rel="canonical" href="https://pdudits.github.io/2017/09/07/Semi-automatic-Jenkins-upgrade-on-Windows.html" />
    <meta name="referrer" content="origin" />
    
    <meta property="og:site_name" content="Not obvious " />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="Semi-automatic Jenkins upgrade on Windows" />
    <meta property="og:description" content="Jenkins offers nice auto-update functionality, where it will download new version, schedules a restart and updates. But what to do when it is unable to download the version? In our company there is this really annoying proxy antivirus scanner, that likes to inspect all jar and war files for viruses," />
    <meta property="og:url" content="https://pdudits.github.io/2017/09/07/Semi-automatic-Jenkins-upgrade-on-Windows.html" />
    <meta property="article:published_time" content="2017-09-07T00:00:00.000Z" />
    <meta property="article:tag" content="Jenkins" />
    <meta property="article:tag" content="Windows" />
    
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="Semi-automatic Jenkins upgrade on Windows" />
    <meta name="twitter:description" content="Jenkins offers nice auto-update functionality, where it will download new version, schedules a restart and updates. But what to do when it is unable to download the version? In our company there is this really annoying proxy antivirus scanner, that likes to inspect all jar and war files for viruses," />
    <meta name="twitter:url" content="https://pdudits.github.io/2017/09/07/Semi-automatic-Jenkins-upgrade-on-Windows.html" />
    
    <script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Article",
    "publisher": "Not obvious ",
    "author": {
        "@type": "Person",
        "name": "Patrik Duditš",
        "image": "https://avatars3.githubusercontent.com/u/1588543?v=4",
        "url": "https://pdudits.github.io/author/pdudits/"
    },
    "headline": "Semi-automatic Jenkins upgrade on Windows",
    "url": "https://pdudits.github.io/2017/09/07/Semi-automatic-Jenkins-upgrade-on-Windows.html",
    "datePublished": "2017-09-07T00:00:00.000Z",
    "keywords": "Jenkins, Windows",
    "description": "Jenkins offers nice auto-update functionality, where it will download new version, schedules a restart and updates. But what to do when it is unable to download the version? In our company there is this really annoying proxy antivirus scanner, that likes to inspect all jar and war files for viruses,"
}
    </script>

    <meta name="generator" content="HubPress" />
    <link rel="alternate" type="application/rss+xml" title="Not obvious " href="https://pdudits.github.io/rss/" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.10.0/styles/atom-one-dark.min.css">
  </head>
  <body class="post-template tag-Jenkins tag-Windows">
    <header id="menu-button" class="expanded">
      <a><i class="icon icon-list"></i></a>
    </header>
    <aside class="cover" style="background: url(https://cloud.githubusercontent.com/assets/1588543/21372338/c07f1c2e-c716-11e6-8daa-aa3b35a2d2cf.jpg) center/cover no-repeat fixed">
      <div class="cover container">
        <div class="profile">
          <a id="avatar-link" title="link to homepage for Not obvious " href="https://pdudits.github.io/#open">
            <img src="https://twitter.com/pdudits/profile_image?size&#x3D;bigger" alt="Not obvious  avatar" class="profile avatar rounded hvr-buzz-out" />
            <h1 id="profile-title">Not obvious </h1>
            <h3 id="profile-resume"></h3>
          </a>
    
          <hr class="divider long" />
          <p>Notes about programming tasks that took too long. By Patrik Duditš. </p>
          <hr class="divider short" />
          <div class="navigation">
            <div class="profile contact">
              
              <nav class="navigation right">
                <ul class="social expanded">
              
                  <!-- Twitter -->
                  <li class="social item hvr-grow-rotate">
                    <a rel="me" href="https://facebook.com/patrik.dudits" title="Facebook account">
                      <i class='icon icon-social-facebook'></i>
                      <span class="label">Facebook</span>
                    </a>
                  </li>
              
                  <!-- Twitter -->
                  <li class="social item hvr-grow-rotate">
                    <a rel="me" href="https://twitter.com/pdudits" title="Twitter account">
                      <i class='icon icon-social-twitter'></i>
                      <span class="label">Twitter</span>
                    </a>
                  </li>
              
              
                  <!-- Github -->
                  <li class="social item hvr-grow-rotate">
                    <a rel="me" href="https://github.com/pdudits" title="Github account">
                      <i class='icon icon-social-github'></i>
                      <span class="label">Github</span>
                    </a>
                  </li>
                  </li>
              
              
              
                  <!-- Github -->
                  <li class="social item hvr-grow-rotate">
                    <a rel="me" href="https://flickr.com/pdudits" title="Flickr account">
                      <i class='icon icon-social-flickr'></i>
                      <span class="label">Flickr</span>
                    </a>
                  </li>
                  </li>
              
              
              
                </ul>
              </nav>
              <!-- <section class="icon icon-search" id="search-container">
      <hr class="divider short" />
      <form id="search-form">
        <input type="text", name="search", placeholder="git, css, javascript,..." id="search-field" />
      </form>
    </section>
     -->
            </div>
          </div>
        </div>
      </div>
    </aside>
    <main>
      <section id="search-results"></section>
      <section class="content">
        

  <article class="post tag-Jenkins tag-Windows">
    <header>
      <div class="post meta">
        <time datetime="07 Sep 2017">07 Sep 2017</time>
        <span class="post tags">in <a href="https://pdudits.github.io/tag/Jenkins/">Jenkins</a> <a href="https://pdudits.github.io/tag/Windows/">Windows</a></span>


        <span class="post reading-time"> ~ <span></span> read.</span>
      </div>
      <a alt="Tweet 'Semi-automatic Jenkins upgrade on Windows'" href="https://twitter.com/intent/tweet?text=Semi-automatic%20Jenkins%20upgrade%20on%20Windows%20%C2%BB&amp;hashtags=Jenkins,Windows&amp;url=https://pdudits.github.io/2017/09/07/Semi-automatic-Jenkins-upgrade-on-Windows.html">
        
        <h1 class="icon-reverse icon-social-twitter-post" id="post-title">Semi-automatic Jenkins upgrade on Windows</h1>
      </a>
    </header>

    <div id="post-content" class="post tag-Jenkins tag-Windows">
      <div class="paragraph">
<p>Jenkins offers nice auto-update functionality, where it will download new version, schedules a restart and updates.
But what to do when it is unable to download the version?</p>
</div>
<div class="paragraph">
<p>In our company there is this really annoying proxy antivirus scanner, that likes to inspect all <code>jar</code> and <code>war</code> files for viruses, so things like Wildfly or Netbeans take hours to download.
That&#8217;s really bad new when one wants to update Jenkins, as it will time out after minute or two.</p>
</div>
<div class="paragraph">
<p>The usual approach I take for plugins that fail to download, is that I download them manually (e. g. by replacing <code>http</code> with <code>https</code> in the mirror link, then the antivirus is bypassed ;)) and upload them into Jenkins.
This doesn&#8217;t work for the main <code>war</code> file, of course.</p>
</div>
<div class="paragraph">
<p>Should I&#8217;ve been running on Linux, I would just download the file, and overwrite existing file.
I&#8217;m on Windows and the process have the file locked.
I would really like just to trigger this logic for upgrading the file at startup.</p>
</div>
<div class="paragraph">
<p>To find out how that works I looked into Jenkins' <a href="https://github.com/jenkinsci/jenkins/blob/master/core/src/main/java/hudson/lifecycle/WindowsServiceLifecycle.java">WindowsLifecycleService</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">    /**
     * On Windows, jenkins.war is locked, so we place a new version under a special name,
     * which is picked up by the service wrapper upon restart.
     */
    @Override
    public void rewriteHudsonWar(File by) throws IOException {
        File dest = getHudsonWar();
        // this should be impossible given the canRewriteHudsonWar method,
        // but let's be defensive
        if(dest==null)  throw new IOException("jenkins.war location is not known.");

        // backing up the old jenkins.war before its lost due to upgrading
        // unless we are trying to rewrite jenkins.war by a backup itself
        File bak = new File(dest.getPath() + ".bak");
        if (!by.equals(bak))
            FileUtils.copyFile(dest, bak);

        String baseName = dest.getName();
        baseName = baseName.substring(0,baseName.indexOf('.'));

        File baseDir = getBaseDir();
        File copyFiles = new File(baseDir,baseName+".copies");

        try (FileWriter w = new FileWriter(copyFiles, true)) {
            w.write(by.getAbsolutePath() + '&gt;' + getHudsonWar().getAbsolutePath() + '\n');
        }
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>So I did the same thing manually:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Downloaded new <code>war</code> file to <code>d:\temp</code></p>
</li>
<li>
<p>Created file jenkins.copies in jenkins' home with content</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>d:/temp/jenkins.war&gt;d:/jenkins/jenkins.war</code></pre>
</div>
</div>
<div class="paragraph">
<p>I saved it with UNIX line endings and verified, that there is indeed just single <code>\n</code> at the end (service will fail to start if that is not the case).</p>
</div>
</li>
<li>
<p>Had jenkins restart once it is idle</p>
</li>
<li>
<p><strong>DONE</strong>. Jenkins did update just as if it had downloaded the file itself.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>I kept the <code>.copies</code> file handy for future updates. I will just put new version in <code>temp</code> and copy the <code>.copies</code> file over.</p>
</div>
    </div>

    <div class="post related">

    </div>

    <footer class="post comments">
        <div id="disqus_thread"></div>
        <script type="text/javascript">
        var disqus_shortname = 'pdudits'; // required: replace example with your forum shortname
        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </footer>

  </article>


        <footer>
          <span class="copyright">
            &copy; 2017. All rights reserved. Built with <a href="https://github.com/Kikobeats/uno-zen" target="_blank">Uno Zen</a> under <a href="http://hubpress.io/" target="_blank">HubPress</a>.
          </span>
        </footer>
      </section>
    </main>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js?v="></script> <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.9.0/moment-with-locales.min.js?v="></script> <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.10.0/highlight.min.js?v="></script> 
      <script type="text/javascript">
        jQuery( document ).ready(function() {
          // change date with ago
          jQuery('ago.ago').each(function(){
            var element = jQuery(this).parent();
            element.html( moment(element.text()).fromNow());
          });
        });

        hljs.initHighlightingOnLoad();
      </script>
       
    <script src='https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML'></script>
    <script src="//pdudits.github.io/themes/uno-zen/assets/js/uno-zen.js?v=1504855821302" type="text/javascript" charset="utf-8"></script>
    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-340613-5', 'auto');
    ga('send', 'pageview');

    </script>
  </body>
</html>
